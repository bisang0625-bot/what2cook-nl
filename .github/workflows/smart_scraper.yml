name: Smart Scraper - Weekly Sales Update

on:
  schedule:
    # ì¼ìš”ì¼ ìžì • (UTC 00:00 = ë„¤ëœëž€ë“œ ì‹œê°„ 01:00/02:00)
    # ì›”ìš”ì¼ ì‹œìž‘ ë§ˆíŠ¸ë“¤ì„ ìœ„í•œ ìŠ¤í¬ëž˜í•‘
    - cron: '0 0 * * 0'
    # í™”ìš”ì¼ ìžì • (UTC 00:00 = ë„¤ëœëž€ë“œ ì‹œê°„ 01:00/02:00)
    # ìˆ˜ìš”ì¼ ì‹œìž‘ ë§ˆíŠ¸ë“¤(Jumbo, Dirk)ì„ ìœ„í•œ ìŠ¤í¬ëž˜í•‘
    - cron: '0 0 * * 2'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡

jobs:
  smart-scrape:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          echo "ðŸ“¦ requirements.txtì—ì„œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          pip install -r requirements.txt
          echo "ðŸ“¦ aiohttp ëª…ì‹œì  ì„¤ì¹˜ (ì˜ì¡´ì„± ë¬¸ì œ ë°©ì§€)..."
          pip install aiohttp>=3.9.0
          # í•„ìš”í•œ íŒ¨í‚¤ì§€ í™•ì¸ (ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨)
          echo "ðŸ” í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
          python -c "import requests; print('âœ… requests í™•ì¸')" || (echo "âŒ requests ì„¤ì¹˜ ì‹¤íŒ¨" && exit 1)
          python -c "import aiohttp; print('âœ… aiohttp í™•ì¸')" || (echo "âŒ aiohttp ì„¤ì¹˜ ì‹¤íŒ¨" && exit 1)
          python -c "import google.generativeai; print('âœ… google-generativeai í™•ì¸')" || (echo "âŒ google-generativeai ì„¤ì¹˜ ì‹¤íŒ¨" && exit 1)
          echo "âœ… ëª¨ë“  í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì™„ë£Œ"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Verify API Key
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ ì˜¤ë¥˜: GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "   GitHub Secretsì— GEMINI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          else
            echo "âœ… GEMINI_API_KEY í™•ì¸ë¨"
          fi

      - name: Run Smart Scraper
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ (ì„¸ì¼ ì •ë³´ ì—…ë°ì´íŠ¸ í™•ì¸ í›„ ìŠ¤í¬ëž˜í•‘)
          echo "ðŸ” ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹œìž‘..."
          echo "ðŸ“… í˜„ìž¬ ì‹œê°„: $(date)"
          echo "ðŸ“‚ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ðŸ“ íŒŒì¼ í™•ì¸:"
          ls -la scraper/smart_scheduler.py scraper/scrape_all_stores.py || echo "âš ï¸ ì¼ë¶€ íŒŒì¼ì´ ì—†ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"
          
          # Python ê²½ë¡œ í™•ì¸
          echo "ðŸ Python ë²„ì „:"
          python --version
          python3 --version || true
          
          # ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ (ì—ëŸ¬ ë°œìƒ ì‹œ ìƒì„¸ ë¡œê·¸ ì¶œë ¥)
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          python scraper/smart_scheduler.py --wait-for-update 2>&1 | tee scraper_output.log || {
            echo ""
            echo "âŒ ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹¤íŒ¨"
            echo "ðŸ“‹ ì—ëŸ¬ ë¡œê·¸:"
            cat scraper_output.log || true
            echo ""
            echo "ðŸ“‹ ë¶„ì„ ëª¨ë“œë¡œ ìž¬ì‹¤í–‰í•˜ì—¬ ìƒì„¸ ì •ë³´ í™•ì¸:"
            python scraper/smart_scheduler.py --analyze || true
            exit 1
          }
        continue-on-error: true

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain data/*.json)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ JSON íŒŒì¼ ë³€ê²½ ê°ì§€ë¨"
            git status --short data/
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git add data/*.json
          git commit -m "bot: update weekly sales data and recipes [skip ci]" || exit 0
          git push || exit 0
          echo "âœ… ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"

      - name: Summary
        if: always()
        run: |
          echo "## Smart Scraper ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
            echo "âœ… **ë³€ê²½ ì‚¬í•­ ê°ì§€ë¨** - ì„¸ì¼ ë°ì´í„°ì™€ ë ˆì‹œí”¼ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ë³€ê²½ëœ íŒŒì¼:" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD~1 data/ 2>/dev/null || git status --short data/ >> $GITHUB_STEP_SUMMARY || echo "íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **ë³€ê²½ ì‚¬í•­ ì—†ìŒ** - ëª¨ë“  ë°ì´í„°ê°€ ìµœì‹  ìƒíƒœìž…ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì„¸ì¼ ì •ë³´ê°€ ì•„ì§ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì´ë¯¸ ìµœì‹  ë°ì´í„°ìž…ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
